---
- name: Update and upgrade Ubuntu packages
  hosts: nodes
  become: true
  vars:
    ansible_user: mchellmer
  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    - name: Update hosts with node maps
      lineinfile:
        path: /etc/hosts
        line: "{{ item.value }} {{ item.key }}"
        state: present
        backup: yes
      loop: "{{ k8s_hostnames | dict2items }}"

    - name: Install master ssh key to nodes
      authorized_key:
        user: "{{ansible_user}}"
        state: present
        key: "{{ lookup('file', ssh_key_path) }}"

  roles:
    - role: k8s_iptables