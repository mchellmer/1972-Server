---
- name: Install and configure isc-dhcp-server and update iptables
  hosts: localhost
  become: true
  tasks:
    - name: Install isc-dhcp-server
      apt:
        name: isc-dhcp-server
        state: present

    - name: Update dhcpd.conf
      template:
        src: dhcpd.conf.j2
        dest: /etc/dhcp/dhcpd.conf
        owner: root
        group: root
        mode: '0644'
      vars:
        dhcp_domain_name: "cluster.home"
      notify:
        - Restart DHCP Server

    - name: Set INTERFACES to eth0
      lineinfile:
        path: /etc/default/isc-dhcp-server
        line: 'INTERFACES="eth0"'
        state: present
        backup: yes
      notify:
        - Restart DHCP Server

    - name: Rename hostname to kubernetes
      hostname:
        name: kubernetes

    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: |
          10.0.0.1 kubernetes
          10.0.0.2 node-1
          10.0.0.3 node-2

    - name: Create k8s.conf for sysctl
      template:
        src: modules.k8s.conf.j2
        dest: /etc/modules-load.d/k8s.conf
        owner: root
        group: root
        mode: '0644'

    - name: Create sysctl.d k8s.conf file
      template:
        src: sysctl.k8s.conf.j2
        dest: /etc/sysctl.d/k8s.conf
        owner: root
        group: root
        mode: '0644'
      notify:
        - Apply sysctl settings

    - name: Enable IP forwarding
      ansible.builtin.lineinfile:
        path: /etc/sysctl.conf
        line: 'net.ipv4.ip_forward=1'
        backup: yes
      notify: Apply sysctl settings

    - name: Save iptables rules to a shell script
      ansible.builtin.copy:
        dest: /usr/local/bin/apply-iptables-rules.sh
        content: |
          #!/bin/bash
          /sbin/iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE
          /sbin/iptables -A FORWARD -i wlan0 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
          /sbin/iptables -A FORWARD -i eth0 -o wlan0 -j ACCEPT
        mode: '0755'

    - name: Create systemd service for iptables-restore
      ansible.builtin.copy:
        dest: /etc/systemd/system/iptables-apply.service
        content: |
          [Unit]
          Description=Set iptables rules on startup for wlan0 and eth0 forwarding

          [Service]
          ExecStart=/usr/local/bin/apply-iptables-rules.sh
          Type=oneshot
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target
        owner: root
        group: root
        mode: '0644'

    - name: Enable and start iptables-restore service
      ansible.builtin.systemd:
        name: iptables-apply
        enabled: yes
        state: restarted
        daemon_reload: yes
    
    - name: Update Ansible hosts file
      lineinfile:
        path: /etc/ansible/hosts
        line: |
          [kubernetes]
          kubernetes
          node-1
          node-2

  handlers:
    - name: Restart DHCP Server
      service:
        name: isc-dhcp-server
        state: restarted
    
    - name: Apply sysctl settings
      command: sysctl --system

- name: Update and upgrade Ubuntu packages
  hosts: kubernetes
  become: true
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
    - name: Upgrade all packages
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
